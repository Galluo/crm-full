# تحليل المتطلبات الجديدة وتصميم معماري مفصل

## 1. المتطلبات الجديدة

بناءً على طلب المستخدم، سيتم توسيع نظام CRM ليشمل الميزات التالية:

### أ. نظام إدارة العملاء (Customer Management System - CMS)
- إضافة عملاء جدد (الاسم، معلومات الاتصال، العنوان، ملاحظات).
- تعديل وحذف معلومات العملاء.
- عرض قائمة بالعملاء مع إمكانية البحث والتصفية.
- ربط الطلبات والمهام بسجل العميل.
- **تاريخ الطلبات لكل عميل:** يجب أن يكون لكل عميل ملف خاص به يتضمن تاريخ جميع الطلبات التي قام بها.

### ب. نظام إنشاء الطلبات (Order Creation System)
- إنشاء طلبات جديدة للعملاء.
- تحديد المنتجات من المخزون وإضافتها للطلب.
- تحديد الكميات والأسعار.
- تتبع حالة الطلب (قيد المعالجة، تم الشحن، مكتمل، ملغى).
- عرض قائمة بالطلبات مع إمكانية البحث والتصفية.

### ج. نظام المخزون وإدارة المنتجات (Inventory and Product Management)
- إضافة منتجات جديدة (الاسم، الوصف، السعر، الكمية المتوفرة).
- تعديل وحذف معلومات المنتجات.
- تتبع كمية المخزون لكل منتج.
- تنبيهات عند انخفاض المخزون.

### د. نظام إدارة الموظفين والصلاحيات (Employee and Permissions Management)
- إضافة مستخدمين/موظفين جدد.
- تحديد صلاحيات مختلفة لكل موظف (مدير، موظف مبيعات، موظف دعم فني، إلخ).
- تعديل وحذف حسابات الموظفين.
- متابعة أداء الموظفين (المهام المسندة، الطلبات التي تم التعامل معها).

### هـ. نظام محادثة بين الموظفين (Internal Chat System)
- نظام محادثة فوري بين الموظفين.
- دعم المحادثات الفردية والجماعية.
- إشعارات للمحادثات الجديدة.

### و. إسناد المهام من المدير إلى الموظفين (Task Assignment)
- قدرة المدير على إسناد المهام لموظفين محددين.
- متابعة حالة المهام المسندة لكل موظف.

## 2. التصميم المعماري المقترح

سيتم توسيع البنية الحالية (Flask Backend + HTML/CSS/JS Frontend) لاستيعاب المتطلبات الجديدة.

### أ. الواجهة الخلفية (Backend - Flask)

**1. تحديث نماذج قاعدة البيانات (SQLAlchemy Models):**
- **User Model:** إضافة حقول للصلاحيات (roles) وتفاصيل الموظفين.
- **Customer Model (جديد):**
  - `id` (Primary Key)
  - `name` (اسم العميل)
  - `email`
  - `phone`
  - `address`
  - `notes`
  - `created_at`, `updated_at`
- **Product Model (جديد):**
  - `id` (Primary Key)
  - `name` (اسم المنتج)
  - `description`
  - `price`
  - `stock_quantity`
  - `created_at`, `updated_at`
- **Order Model (جديد):**
  - `id` (Primary Key)
  - `customer_id` (Foreign Key to Customer)
  - `order_date`
  - `total_amount`
  - `status` (قيد المعالجة، تم الشحن، مكتمل، ملغى)
  - `created_by` (Foreign Key to User)
  - `created_at`, `updated_at`
- **OrderItem Model (جديد):** (لربط المنتجات بالطلبات)
  - `id` (Primary Key)
  - `order_id` (Foreign Key to Order)
  - `product_id` (Foreign Key to Product)
  - `quantity`
  - `price_at_order`
- **Chat Message Model (جديد):**
  - `id` (Primary Key)
  - `sender_id` (Foreign Key to User)
  - `receiver_id` (Foreign Key to User, for direct messages, or null for group chat)
  - `group_id` (Foreign Key to ChatGroup, if group chat)
  - `message_text`
  - `timestamp`
  - `is_read`
- **ChatGroup Model (جديد):** (للمحادثات الجماعية)
  - `id` (Primary Key)
  - `name` (اسم المجموعة)
  - `created_by` (Foreign Key to User)
  - `created_at`
- **ChatGroupMember Model (جديد):** (لربط المستخدمين بالمجموعات)
  - `id` (Primary Key)
  - `group_id` (Foreign Key to ChatGroup)
  - `user_id` (Foreign Key to User)

**2. توسيع API Endpoints:**
- **Customers API:**
  - `GET /api/customers`
  - `GET /api/customers/{id}`
  - `POST /api/customers`
  - `PUT /api/customers/{id}`
  - `DELETE /api/customers/{id}`
  - `GET /api/customers/{id}/orders` (تاريخ الطلبات للعميل)
- **Products API:**
  - `GET /api/products`
  - `GET /api/products/{id}`
  - `POST /api/products`
  - `PUT /api/products/{id}`
  - `DELETE /api/products/{id}`
- **Orders API:**
  - `GET /api/orders`
  - `GET /api/orders/{id}`
  - `POST /api/orders`
  - `PUT /api/orders/{id}`
  - `DELETE /api/orders/{id}`
- **Users API (توسيع):**
  - إضافة حقول `role` و `permissions`.
  - `PUT /api/users/{id}/assign_task` (لإسناد المهام)
- **Chat API (جديد):**
  - `GET /api/chat/messages` (رسائل المستخدم)
  - `POST /api/chat/messages` (إرسال رسالة)
  - `GET /api/chat/groups` (المجموعات)
  - `POST /api/chat/groups` (إنشاء مجموعة)
  - `POST /api/chat/groups/{id}/members` (إضافة أعضاء للمجموعة)

**3. إدارة الصلاحيات (Permissions Management):**
- سيتم تطبيق نظام صلاحيات دقيق على مستوى الواجهة الخلفية لضمان أن المستخدمين يمكنهم الوصول فقط إلى الموارد التي لديهم إذن بها.
- يمكن استخدام `Flask-JWT-Extended` لتخزين الصلاحيات في الـ JWT أو جلبها من قاعدة البيانات عند الحاجة.

### ب. الواجهة الأمامية (Frontend - HTML/CSS/JS)

**1. صفحات جديدة:**
- **صفحة إدارة العملاء:** عرض قائمة العملاء، إضافة/تعديل/حذف عميل، عرض تاريخ الطلبات للعميل.
- **صفحة إدارة المنتجات/المخزون:** عرض قائمة المنتجات، إضافة/تعديل/حذف منتج، تتبع المخزون.
- **صفحة إدارة الطلبات:** عرض قائمة الطلبات، إنشاء طلب جديد، تعديل حالة الطلب.
- **صفحة إدارة الموظفين:** عرض قائمة الموظفين، إضافة/تعديل/حذف موظف، تعيين صلاحيات.
- **صفحة المحادثة:** واجهة محادثة فورية.

**2. تحديث الصفحات الحالية:**
- **صفحة المهام:** تعديل واجهة إسناد المهام لتشمل اختيار الموظفين.
- **لوحة التحكم:** إضافة إحصائيات وملخصات للميزات الجديدة (العملاء، الطلبات، المخزون).

**3. تحديث المكونات:**
- **Navigation Bar:** إضافة روابط للميزات الجديدة.
- **Forms:** إنشاء نماذج لإضافة/تعديل العملاء، المنتجات، الطلبات، الموظفين.
- **Tables:** تحديث الجداول لعرض البيانات الجديدة.
- **Real-time updates:** استخدام WebSockets (أو تقنيات مماثلة) لنظام المحادثة والإشعارات الفورية (قد يتطلب ذلك مكتبة إضافية مثل Flask-SocketIO).

## 3. خطة التنفيذ التفصيلية (مرحلة 1)

في هذه المرحلة، سأركز على تحليل المتطلبات وتصميم الهيكل. الخطوات المحددة هي:

- [x] مراجعة شاملة للمتطلبات الجديدة وتوضيح أي نقاط غامضة.
- [x] تصميم نماذج قاعدة البيانات الجديدة (Customers, Products, Orders, OrderItems, ChatMessages, ChatGroups, ChatGroupMembers).
- [x] تحديد وتوثيق جميع API Endpoints الجديدة والمعدلة.
- [x] تخطيط هيكل الواجهة الأمامية للميزات الجديدة.
- [x] تحديث ملف `todo.md` ليعكس هذه الخطة.

## 4. المخاطر والتحديات المحتملة

- **تعقيد قاعدة البيانات:** إضافة جداول وعلاقات جديدة قد تزيد من تعقيد الاستعلامات.
- **تكامل الميزات:** ضمان عمل جميع الميزات الجديدة معًا بسلاسة.
- **الأداء:** مع زيادة حجم البيانات والميزات، قد يتأثر الأداء.
- **نظام المحادثة:** يتطلب تقنيات الوقت الفعلي (WebSockets) التي قد تكون أكثر تعقيدًا في التنفيذ.
- **إدارة الصلاحيات:** تصميم نظام صلاحيات مرن وقوي قد يكون تحديًا.

## 5. الخطوات التالية

بعد الانتهاء من هذه المرحلة، سأنتقل إلى المرحلة الثانية: **توسيع وتعديل قاعدة البيانات والواجهة الخلفية**، حيث سأقوم بتنفيذ نماذج قاعدة البيانات الجديدة وجميع API Endpoints المطلوبة.

